<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Bill Wurtz Question Search</title>
    <meta name="description" content="A searchable archive of questions and answers from billwurtz.com">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: monospace;
            word-wrap: break-word;
            background-color: #323232;
            color: #FFFFFF;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        a {
            color: #00FF00;
        }
        a:visited {
            color: #67FF79;
        }
        h1 {
            font-family: initial;
            font-weight: normal;
        }
        #search-container {
            margin-bottom: 2em;
        }
        #search-bar {
            width: 100%;
            padding: 12px;
            font-size: 1.2em;
            border: 1px solid #555;
            background-color: #222;
            color: #fff;
            border-radius: 4px;
            box-sizing: border-box;
        }
        #results-info, #loading-indicator {
            margin-top: 1em;
            font-style: italic;
            color: #ccc;
            text-align: center;
        }
        #results-container h3 {
           margin-top: 2em;
           margin-bottom: 1em;
        }
        .question-item {
            margin-bottom: 2em;
        }
        mark {
           background-color: #E9EC54;
           color: #000;
           padding: 1px 2px;
           border-radius: 2px;
        }
        /* Styles copied directly from billwurtz.com */
        dco { color:#E9EC54; }
        qco { color:#B387FF; }
    </style>
</head>
<body>
    <h1>
        Se<font color="#00EE3B">a</font>rch
        Bill W<font color="#00EE3B">u</font>rtz
        Qu<font color="#00EE3B">e</font>stions
    </h1>

    <div id="search-container">
        <input type="search" id="search-bar" placeholder="search through space and time..." autofocus>
        <div id="results-info">Loading questions from the archive...</div>
    </div>

    <div id="results-container"></div>
    <div id="loading-indicator" style="display: none;">Loading more questions...</div>

    <script>
        // --- State Management ---
        let allQuestions = [];
        let fileManifest = [];
        let currentFileIndex = 0;
        let isLoadingMore = false;
        let searchIsActive = false;
        let allDataLoadedForSearch = false;

        // --- DOM Elements ---
        const searchInput = document.getElementById('search-bar');
        const resultsContainer = document.getElementById('results-container');
        const resultsInfo = document.getElementById('results-info');
        const loadingIndicator = document.getElementById('loading-indicator');
        const DATA_BASE_URL = 'https://adammady.github.io/billwurtzsearch/data/';

        // --- Utility Functions ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function getTextContentFromHtml(html) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || "";
        }

        // --- Rendering Functions ---
        function renderQuestions(questions, highlightQuery = '') {
            const fragment = document.createDocumentFragment();
            questions.forEach(item => {
                const div = document.createElement('div');
                div.className = 'question-item';
                let finalHtml = item.html;
                if (highlightQuery) {
                    const regex = new RegExp(highlightQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                    finalHtml = finalHtml.replace(regex, match => `<mark>${match}</mark>`);
                }
                div.innerHTML = finalHtml;
                fragment.appendChild(div);
            });
            resultsContainer.appendChild(fragment);
        }

        // --- Data Loading Functions ---
        async function loadNextFile() {
            if (isLoadingMore || currentFileIndex >= fileManifest.length) {
                if (currentFileIndex >= fileManifest.length) {
                     resultsInfo.textContent = `All ${allQuestions.length.toLocaleString()} questions loaded.`;
                }
                return;
            }

            isLoadingMore = true;
            loadingIndicator.style.display = 'block';

            try {
                const fileName = fileManifest[currentFileIndex];
                const response = await fetch(`${DATA_BASE_URL}${fileName}`);
                if (!response.ok) throw new Error(`Failed to fetch ${fileName}`);
                const newQuestions = await response.json();
                
                allQuestions.push(...newQuestions);
                renderQuestions(newQuestions);
                currentFileIndex++;
                resultsInfo.textContent = `Showing ${allQuestions.length.toLocaleString()} questions...`;

            } catch (error) {
                console.error("Error loading more data:", error);
                resultsInfo.textContent = 'Error loading more questions.';
            } finally {
                isLoadingMore = false;
                loadingIndicator.style.display = 'none';
            }
        }
        
        async function loadAllDataForSearch() {
             if (allDataLoadedForSearch) return;
             resultsInfo.textContent = `Loading all ${fileManifest.length * 50} questions for search...`;
             isLoadingMore = true; // Prevent scrolling from triggering loads
             
             const filesToLoad = fileManifest.slice(currentFileIndex);
             const promises = filesToLoad.map(file => fetch(`${DATA_BASE_URL}${file}`).then(res => res.json()));

             try {
                const remainingChunks = await Promise.all(promises);
                remainingChunks.forEach(chunk => allQuestions.push(...chunk));
                allDataLoadedForSearch = true;
                currentFileIndex = fileManifest.length;
             } catch (error) {
                console.error("Failed to load all data for search:", error);
                resultsInfo.textContent = "Could not load all data for search.";
             } finally {
                isLoadingMore = false;
             }
        }


        // --- Search Logic ---
        const performSearch = debounce(async function() {
            const query = searchInput.value.toLowerCase().trim();

            if (!query) {
                searchIsActive = false;
                resultsContainer.innerHTML = ''; // Clear search results
                renderQuestions(allQuestions); // Re-render what we have loaded
                resultsInfo.textContent = `Showing ${allQuestions.length.toLocaleString()} questions...`;
                return;
            }

            searchIsActive = true;
            
            if (!allDataLoadedForSearch) {
                await loadAllDataForSearch();
            }

            const startTime = performance.now();
            const filteredResults = allQuestions.filter(item => {
                if (!item.plainText) {
                    item.plainText = getTextContentFromHtml(item.html).toLowerCase();
                }
                return item.plainText.includes(query);
            });
            const endTime = performance.now();

            resultsInfo.textContent = 
                `${filteredResults.length.toLocaleString()} results found in ${Math.round(endTime - startTime)}ms.`;

            resultsContainer.innerHTML = ''; // Clear previous results
            renderQuestions(filteredResults, query);

        }, 300);

        // --- Event Listeners ---
        window.addEventListener('scroll', () => {
            if (searchIsActive || isLoadingMore) return;
            
            // Check if user is near the bottom of the page
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                loadNextFile();
            }
        });

        // --- Initialization ---
        async function initialize() {
            searchInput.disabled = true;
            try {
                const manifestResponse = await fetch(`${DATA_BASE_URL}manifest.json`);
                if (!manifestResponse.ok) throw new Error('Manifest not found');
                const manifest = await manifestResponse.json();
                fileManifest = manifest.files;

                await loadNextFile(); // Load the first file

                searchInput.disabled = false;
                searchInput.focus();
                searchInput.addEventListener('input', performSearch);
            } catch (error) {
                resultsInfo.textContent = 'Fatal Error: Could not load the question archive manifest. Please check the console.';
                console.error(error);
            }
        }

        window.onload = initialize;
    </script>
</body>
</html>
