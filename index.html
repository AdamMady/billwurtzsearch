<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Bill Wurtz Question Search</title>
    <meta name="description" content="Bill Wurtz Search, 90.000+ questions & answers at your fingertips.">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <style>
        /* Basic colors / typography like sample */
        dco { color: #E9EC54; }
        qco { color: #B387FF; }
        rco { color: #ff6600; }
        green { color: #00cc00; }
        blue { color: #5555ff; }
        white { color: #000000; }
        lightred { color: #ff6666; }
        strike { text-decoration: line-through; }
        red { color: #ff4444; }
        yellow { color: #ffff00; }
        lightgreen { color: #b3ffb3; }

        body {
            margin: 0;
            padding: 10px;
            background-color: #323232;
            color: #fff;
            font-family: monospace;
            word-wrap: break-word;
            font-size: 14px;
        }
        a { color: #00FF00; text-decoration: none; }
        a:visited { color: #67FF79; }
        h1 { font-family: initial; font-weight: normal; margin-top:0; }
        #search-bar {
            width: 100%;
            padding: 10px;
            font-size: 1.1em;
            background: #222;
            border: 1px solid #555;
            color: #fff;
            box-sizing: border-box;
            margin-bottom: 6px;
        }
        #results-info {
            font-style: italic;
            color: #ccc;
            margin-bottom: 8px;
        }
        .question-item {
            margin-bottom: 1.5em;
        }
        mark {
            background-color: #E9EC54;
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
        }
        .loading {
            text-align: center;
            padding: 10px;
            font-style: italic;
            color: #aaa;
        }
        /* make content span entire width */
        #results-container {
            width: 100%;
        }
    </style>
</head>
<body>
    <h1>Se<font color="#00EE3B">a</font>rch Bill W<font color="#00EE3B">u</font>rtz Qu<font color="#00EE3B">e</font>stions</h1>
    <input type="search" id="search-bar" placeholder="search through space and time..." autofocus>
    <div id="results-info">Loading questions from the archive...</div>
    <div id="results-container"></div>
    <div id="loading-indicator" class="loading" style="display:none;">Loading more questions...</div>

    <script>
        const DATA_BASE_URL = 'https://adammady.github.io/billwurtzsearch/data/';
        let fileManifest = [];
        let allQuestions = [];
        let currentFileIndex = 0;
        let isLoading = false;
        let allLoadedForSearch = false;
        let searchActive = false;

        const searchInput = document.getElementById('search-bar');
        const resultsInfo = document.getElementById('results-info');
        const resultsContainer = document.getElementById('results-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        function debounce(fn, wait) {
            let t;
            return (...args) => {
                clearTimeout(t);
                t = setTimeout(() => fn(...args), wait);
            };
        }

        function getTextContentFromHtml(html) {
            const d = document.createElement('div');
            d.innerHTML = html;
            return d.textContent || '';
        }

        function renderQuestions(arr, highlight='') {
            resultsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            arr.forEach(item => {
                const div = document.createElement('div');
                div.className = 'question-item';
                let html = item.html;
                if (highlight) {
                    const esc = highlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(esc, 'gi');
                    html = html.replace(regex, m => `<mark>${m}</mark>`);
                }
                div.innerHTML = html;
                fragment.appendChild(div);
            });
            resultsContainer.appendChild(fragment);
        }

        async function loadFile(idx) {
            if (idx >= fileManifest.length) return;
            isLoading = true;
            loadingIndicator.style.display = 'block';
            try {
                const name = fileManifest[idx];
                const res = await fetch(`${DATA_BASE_URL}${name}`);
                if (!res.ok) throw new Error('fetch failed');
                const chunk = await res.json();
                allQuestions.push(...chunk);
                if (!searchActive) {
                    renderQuestions(allQuestions);
                }
                currentFileIndex++;
                resultsInfo.textContent = `Showing ${allQuestions.length.toLocaleString()} questions...`;
            } catch (e) {
                console.error(e);
                resultsInfo.textContent = 'Error loading data.';
            } finally {
                isLoading = false;
                loadingIndicator.style.display = 'none';
            }
        }

        async function loadNextFile() {
            if (isLoading || currentFileIndex >= fileManifest.length) return;
            await loadFile(currentFileIndex);
        }

        async function loadAllForSearch() {
            if (allLoadedForSearch) return;
            resultsInfo.textContent = `Loading all ${fileManifest.length * 50} questions for search...`;
            isLoading = true;
            const pending = [];
            for (let i = currentFileIndex; i < fileManifest.length; i++) {
                pending.push(fetch(`${DATA_BASE_URL}${fileManifest[i]}`).then(r => r.json()));
            }
            try {
                const rest = await Promise.all(pending);
                rest.forEach(chunk => allQuestions.push(...chunk));
                allLoadedForSearch = true;
            } catch (e) {
                console.error('Failed to load all:', e);
                resultsInfo.textContent = 'Failed to load all data for search.';
            } finally {
                isLoading = false;
            }
        }

        const doSearch = debounce(async () => {
            const q = searchInput.value.toLowerCase().trim();
            if (!q) {
                searchActive = false;
                renderQuestions(allQuestions);
                resultsInfo.textContent = `Showing ${allQuestions.length.toLocaleString()} questions...`;
                return;
            }
            searchActive = true;
            if (!allLoadedForSearch) await loadAllForSearch();
            const start = performance.now();
            const filtered = allQuestions.filter(item => {
                if (!item.plainText) {
                    item.plainText = getTextContentFromHtml(item.html).toLowerCase();
                }
                return item.plainText.includes(q);
            });
            const end = performance.now();
            resultsInfo.textContent = `${filtered.length.toLocaleString()} results in ${Math.round(end - start)}ms.`;
            renderQuestions(filtered, q);
        }, 250);

        window.addEventListener('scroll', () => {
            if (searchActive || isLoading) return;
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
                loadNextFile();
            }
        });

        searchInput.addEventListener('input', doSearch);

        async function init() {
            try {
                const manifestRes = await fetch(`${DATA_BASE_URL}manifest.json`);
                if (!manifestRes.ok) throw new Error('no manifest');
                const manifest = await manifestRes.json();
                fileManifest = manifest.files || [];
                await loadNextFile(); // first chunk
                searchInput.disabled = false;
                searchInput.focus();
            } catch (e) {
                console.error(e);
                resultsInfo.textContent = 'Fatal: Could not load manifest.';
            }
        }

        init();
    </script>
</body>
</html>
